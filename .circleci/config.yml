version: 2
jobs:
  build:

    docker:
      - image: ocaml/opam2

    steps:
      - checkout

      - run:
          name: Install OCaml packages
          command: |
            sudo apt-get install -y m4
            opam install dune && eval $(opam env)
            echo "HERE"
            dune external-lib-deps --missing @install
            echo "THERE"
            eval "$(dune external-lib-deps --missing @install 2>&1 | grep 'opam' | sed 's/.*\(opam .*\)/\1/') -y"

      - run:
          name: Build Seashell
          command: |
            eval $(opam env)
            dune build
            dune install

      - run:
          name: Run Seashell examples
          command: |
            eval $(opam env)
            dune build
            dune install
            cd examples
            make all
